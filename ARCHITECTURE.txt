Notion Command Central Dispatcher — Architecture (src/)
======================================================

This document explains the current repo structure with a focus on `src/`:
- What each module is responsible for
- What each file does
- The end-to-end request flow: HTTP → webhook boundary → routing → side effects (commands/fanout) → Notion API

It is written from the code as it exists today (not an aspirational design).


High-level flow (one request)
-----------------------------

1) `src/index.ts` (process orchestrator)
   - Boots the process, wires routes, and decides what layers run in what order.
   - Defines `/webhook` and `/health`.
   - For `/webhook`:
     - Generates `requestId`
     - Calls webhook boundary for auth + normalization
     - Calls routing for routing + dispatch (today routing still performs side effects)
     - Maps boundary errors to HTTP status codes

2) `src/webhook/*` (webhook boundary)
   - Authenticates the request (shared secret header) and normalizes the Notion automation payload.
   - Importantly: this module does NOT call routing/dispatch anymore. It only returns a typed `WebhookEvent`.

3) `src/routing/*` (routing layer)
   - Loads routing config from Notion (Dispatch Config DB), caches it, and matches rules.
   - Entry point `routeWebhookEvent` currently does BOTH:
     - routing decision (which rules matched, whether fanout applies)
     - dispatch side effects (create Commands, enqueue fanout)

4) `src/dispatch/*` (side effects)
   - Contains side-effect helpers and background processing:
     - Notion command creation
     - Fanout coordinator + fanout processor
   - `src/dispatch/index.ts` currently exists as a compatibility re-export of routing’s entrypoint.

5) `src/notion/*` (Notion client + primitives)
   - A globally throttled request client (3 requests/second) with retries for 429/5xx.
   - Higher-level primitives for:
     - enumerating objective tasks (pagination safe)
     - resolving objective from a task relation
     - fetching a full page


Directory map
-------------

src/
  index.ts
  server.ts
  config.ts
  types.ts
  webhook/
    index.ts
    normalizeWebhook.ts
    errors.ts
  routing/
    index.ts
    routeWebhookEvent.ts
    match.ts
    configDatabase/
      index.ts
      loadRoutes.ts
      types.ts
  dispatch/
    index.ts
    createCommand.ts
    fanout/
      index.ts
      runObjectiveFanout.ts
  notion/
    client.ts
    api.ts


Module + file responsibilities
------------------------------

src/index.ts
  Role: Process orchestrator + HTTP route wiring.
  Responsibilities:
  - Create the Express app via `createApp()`.
  - Define:
    - GET `/health` → `{ ok: true }`
    - POST `/webhook`
  - For `/webhook`:
    - Generate `requestId` with `crypto.randomUUID()`
    - Log `[/webhook] webhook_received` with request_id and raw body (note: can be large)
    - Call `authenticateAndNormalizeWebhook({ headers, body })`
    - Call `routeWebhookEvent({ requestId, webhookEvent })`
    - Handle errors:
      - `WebhookAuthError` → 401
      - `WebhookParseError` → 400
      - other errors → 500

src/server.ts
  Role: Pure HTTP transport.
  Responsibilities:
  - Create Express app instance.
  - Install `express.json()` middleware.
  Non-responsibilities:
  - No routes
  - No auth/normalize
  - No routing/dispatch
  - No `listen()`

src/config.ts
  Role: Environment/config loading.
  Responsibilities:
  - `dotenv.config()` on import.
  - `loadConfig()` validates required vars and returns a typed object.
  Required env:
  - NOTION_TOKEN (required)
  Default env:
  - PORT defaults to 3000
  Optional env (used by routing/dispatch):
  - Commands DB config (IDs for DB + properties)
  - Dispatch Config DB config (DB id, Enabled property id/name, etc.)
  Notes:
  - `dispatchConfigRulePropId` exists in config but is not used by the current typed config implementation.

src/types.ts
  Role: Cross-module domain types.
  - `AutomationEvent`: fanout job payload (objective + origin task + matched route names).
  - `ProcessorResult`: fanout execution summary (`ok`, `created`, `failed`).


src/webhook/errors.ts
  Role: Typed errors for HTTP mapping.
  - `WebhookAuthError`: shared secret failed.
  - `WebhookParseError`: payload isn’t shaped like a Notion page webhook.

src/webhook/normalizeWebhook.ts
  Role: Payload normalization.
  Responsibilities:
  - Validate the inbound payload resembles `{ data: { object: "page", id, parent.database_id, properties } }`
  - Return `WebhookEvent`:
    - `originDatabaseId` (raw, with dashes as Notion sends)
    - `originPageId`
    - `properties` (raw Notion properties object)
  Non-goals:
  - No assumptions about “Status” or any specific property names.

src/webhook/index.ts
  Role: Webhook boundary (auth + normalization only).
  Entry point:
  - `authenticateAndNormalizeWebhook({ headers, body }) -> WebhookEvent`
  Responsibilities:
  - If `WEBHOOK_SHARED_SECRET` is configured, compare against `x-webhook-secret` header.
  - Normalize via `normalizeWebhookEvent`.
  - Throw typed errors (`WebhookAuthError`, `WebhookParseError`) for orchestrator mapping.
  Non-responsibilities:
  - Does not call routing/dispatch.


src/routing/index.ts
  Role: Routing module entrypoint exports.
  - Re-exports `routeWebhookEvent` and its types.

src/routing/routeWebhookEvent.ts
  Role: Main routing entrypoint (today: routing + dispatch combined).
  Entry point:
  - `routeWebhookEvent({ requestId, webhookEvent }) -> RouteWebhookResult`
  Responsibilities:
  - Load config snapshot via `getDispatchConfigSnapshot()` (routing config database).
  - Normalize DB id:
    - `originDatabaseIdKey = originDatabaseId.replace(/-/g, "").toLowerCase()`
    - This normalizes dashed vs undashed user-entered IDs.
  - Match rules:
    - Builds `DispatchEvent { originDatabaseId, originPageId, properties }`
    - Calls `matchRoutes(event, snapshot.routes)`
  - No-op if no routes matched:
    - returns `{ commands_created: 0, fanout_applied: false }`
  - Fanout gating:
    - if mapping exists for that origin DB id, calls `enqueueObjectiveFanoutFromOrigin(...)`
    - passes `matchedRouteNames` and the objective-tasks property id
    - skips origin command creation to avoid duplicates
  - Single-object command creation:
    - if fanout not applied, creates one command per matched route
  Notes:
  - `objective_id` is returned as `null` in responses; objective resolution happens in fanout subsystem.

src/routing/match.ts
  Role: Rule matching engine.
  Entry point:
  - `matchRoutes(event, routes) -> matched routes`
  Responsibilities:
  - Filter routes by `databaseId`.
  - Apply `predicate.equals` where keys are Notion property names and value is string equality.
  - Extracts comparable values from Notion property objects:
    - status, select, multi_select, title, rich_text, number, checkbox
  - Logs:
    - `[dispatch] dispatch_rule_matched`
    - `[dispatch] dispatch_rule_mismatch`
  Note:
  - Logging prefix still says `[dispatch]` even though file now lives under routing.

src/routing/configDatabase/types.ts
  Role: Typed representation of the Dispatch Config DB.
  - `DispatchRoute`: routeName + databaseId + optional predicate.
  - `DispatchPredicate`: currently only equality checks (`equals`).
  - `FanoutMapping`: config that makes a task database eligible for fanout.
  - `DispatchConfigSnapshot`: `{ routes, fanoutMappings }`.

src/routing/configDatabase/loadRoutes.ts
  Role: Load typed routing config from Notion database.
  Entry point:
  - `loadDispatchConfig() -> DispatchConfigSnapshot`
  Responsibilities:
  - `POST /databases/{DISPATCH_CONFIG_DB_ID}/query` using `notionRequest`.
  - Pagination loop via `has_more` and `next_cursor`.
  - Parse each config row:
    - Reads:
      - "Origin Database ID" (rich_text)
      - "Rule Tyoe" (select)
      - "Condition 1: Property Name" (rich_text)
      - "Condition 1: Value" (rich_text)
      - "Task → Objective Property ID" (rich_text) for fanout rows
      - "Objective → Tasks Property ID" (rich_text) for fanout rows
      - Enabled checkbox (by name or id from env var `DISPATCH_CONFIG_ENABLED_PROP_ID`)
      - Name/title (title property)
    - Normalizes database IDs (strip dashes + lowercase).
    - Emits:
      - DispatchCommand → DispatchRoute
      - ObjectiveFanoutConfig → FanoutMapping
  Logging:
  - Very verbose debug logs:
    - config_cache_refresh_started
    - config_row_evaluated
    - config_row_properties (dumps full properties object)
    - config_row_invalid / fanout_config_row_invalid

src/routing/configDatabase/index.ts
  Role: Config cache mini-orchestrator (stale-while-refresh).
  Entry point:
  - `getDispatchConfigSnapshot()`
  Behavior:
  - Cold start blocks until the first snapshot loads.
  - TTL 60s; on expiry, returns stale snapshot and refreshes async.


src/dispatch/index.ts
  Role: Compatibility re-export.
  - Re-exports `routeWebhookEvent` and types from routing.
  - There is no longer a “dispatch entrypoint” implemented here.

src/dispatch/createCommand.ts
  Role: Side-effect helper: creates a Command page in the Commands DB.
  Entry point:
  - `createCommand(args)`
  Responsibilities:
  - Constructs Notion `/pages` body with:
    - parent database = Commands DB
    - target relation (page id)
    - trigger key rich_text
    - optional directive command multi_select
    - a title property (default "Name" or configured)
  - Calls `notionRequest({ path: "/pages", method: "POST" })`

src/dispatch/fanout/index.ts
  Role: Fanout scheduler + single-flight coordinator.
  Entry point:
  - `enqueueObjectiveFanoutFromOrigin({ originTaskId, taskObjectivePropId, objectiveTasksPropId, matchedRouteNames })`
  Responsibilities:
  - Resolve objectiveId from origin task via `getObjectiveIdForTask`.
  - Enforce single-flight per objective:
    - if inFlight, log skip and drop the event.
  - Fire-and-forget background run:
    - `runObjectiveFanout({ taskId, objectiveId, objectiveTasksPropId, matchedRouteNames })`

src/dispatch/fanout/runObjectiveFanout.ts
  Role: Fanout executor.
  Entry point:
  - `runObjectiveFanout(event) -> ProcessorResult`
  Responsibilities:
  - Enumerate objective’s tasks via `getObjectiveTaskIds` (pagination-safe).
  - For each task and each matched route name from the origin:
    - Create a command (one per task per matched origin rule).
    - Does NOT re-run rule matching per task.
  - Uses trigger key from env (`COMMAND_TRIGGER_KEY`) or event override.


src/notion/client.ts
  Role: Notion HTTP client wrapper with global throttling + retries.
  Responsibilities:
  - Global rate limit: ~3 requests/second (simple interval worker + queue).
  - Retry 429 and 5xx up to 3 times with exponential backoff (500ms, 1000ms, 2000ms).
  - `notionRequest({ path, method, body }) -> Response`
  Notes:
  - Uses Node’s global `fetch` (Node 20+).
  - The queue worker uses `setInterval`; requests are paced in 1s windows.

src/notion/api.ts
  Role: Higher-level Notion primitives used by routing/fanout.
  Used by current flow:
  - `getObjectiveTaskIds(objectiveId, tasksRelationPropIdOverride?)`
    - Calls `/pages/{objectiveId}/properties/{relationPropId}` and paginates.
  - `getObjectiveIdForTask(taskId, taskObjectivePropId)`
    - Calls `/pages/{taskId}/properties/{propId}` and supports multiple response shapes.
  - `getPage(pageId)` returns `{ id, parent, properties }` (not used in current routing/fanout path).
  Legacy / currently unused:
  - `createCommand(input)` (older command creator; routing uses `dispatch/createCommand.ts` instead).


Current “big picture” boundaries
--------------------------------

- Transport boundary:
  - `src/server.ts` is pure Express wiring.
  - `src/index.ts` is the actual server/orchestrator.

- Webhook boundary:
  - `src/webhook/*` only authenticates + normalizes.

- Routing boundary:
  - `src/routing/*` owns config loading/caching and rule evaluation.
  - `routeWebhookEvent` currently performs side effects too (commands + fanout enqueue).

- Side effects / background work:
  - `src/dispatch/*` creates commands and runs fanout in the background.
  - `src/notion/*` is the only layer that talks to the Notion API.


